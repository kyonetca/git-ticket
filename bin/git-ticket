#!/bin/sh

COMMIT=1
if [ "$1" = "-C" ]; then
	COMMIT=0
	shift
fi

if [ -z "$1" ]; then
	echo "You must supply a subject for the ticket." 1>&2
	exit 1
fi

SUBDIRECTORY_OK=1
if ! . "`git --exec-path`/git-sh-setup"; then
	exit 1
fi
if ! cd_to_toplevel; then
	exit 1
fi

mkdir -p .tickets
cd .tickets

NAME="`echo "$*" | sed -e's/\//-/'`"

if [ ! -f "$NAME" ]; then
	echo -n "From: " >> "$NAME"
	git var GIT_AUTHOR_IDENT | sed -e's/^\(.*\) [^ ]* [^ ]*$/\1/' >> "$NAME"
	echo -n "Date: " >> "$NAME"
	date +"%a, %d %b %Y %H:%M:%S %z (%Z)" >> "$NAME"
	echo "Subject: $*" >> "$NAME"
	echo "Status: New" >> "$NAME"
	echo "Type: " >> "$NAME"
	echo >> "$NAME"
	echo >> "$NAME"
fi

git_editor "$NAME"

if [ -z "`tail -n2 "$NAME" | sed -e's/\n\n//'`" ]; then
	rm -f "$NAME"
	echo "Cancelled" 1>&2
	exit
fi

git add "$NAME"
if [ "$COMMIT" -eq 1 ]; then
	git commit -m"New Ticket: $*"
fi
